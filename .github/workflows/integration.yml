name: integration

on: [push, pull_request]

jobs:
  integration:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python: 
          - 2.7.18
          - 3.6.15
          - 3.9.17
        dirac_version:
          - rel-v8r0
          - integration

    container: python:${{ matrix.python }}-slim

    steps:
      - uses: actions/checkout@v4
      - name: Retrieve the secret and decode it to a file
        env:
          HOSTCERT_BASE64: ${{ secrets.HOSTCERT_BASE64 }}
          HOSTKEY_BASE64: ${{ secrets.HOSTKEY_BASE64 }}
        run: |
          cd Pilot
          mkdir -p etc/grid-security
          echo $HOSTCERT_BASE64 | base64 --decode > etc/grid-security/hostcert.pem
          echo $HOSTKEY_BASE64 | base64 --decode > etc/grid-security/hostkey.pem
          chmod 440 etc/grid-security/hostcert.pem
          chmod 400 etc/grid-security/hostkey.pem
      - name: tests
        run: |
          cd Pilot
          cp ../tests/CI/pilot_oldSchema.json pilot.json
          sed -i "s/VAR_JENKINS_SITE/DIRAC.Jenkins.ch/g" pilot.json
          sed -i "s/VAR_JENKINS_CE/jenkins.cern.ch/g" pilot.json
          sed -i "s/VAR_JENKINS_QUEUE/jenkins-queue_not_important/g" pilot.json
          sed -i "s/VAR_DIRAC_VERSION/${{ matrix.dirac_version }}/g" pilot.json
          sed -i "s#VAR_CS#https://lbcertifdirac70.cern.ch:9135/Configuration/Server#g" pilot.json
          sed -i "s#VAR_USERDN#/DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=alboyer/CN=819281/CN=Alexandre Franck Boyer#g" pilot.json
          sed -i "s#VAR_USERDN_GRIDPP#${DIRACUSERDN_GRIDPP}#g" pilot.json
          python dirac-pilot.py --modules https://github.com/DIRACGrid/DIRAC.git:::DIRAC:::${{ matrix.dirac_version }} -M 1 -S DIRAC-Certification -N jenkins.cern.ch -Q jenkins-queue_not_important -n DIRAC.Jenkins.ch --cert --certLocation=${GITHUB_WORKSPACE}/Pilot/etc/grid-security --debug
          cat pilot.cfg

  matching:
    runs-on: ubuntu-latest

    container: python:3.9.17-slim


    steps:
      - uses: actions/checkout@v4
      - name: Retrieve the secret and decode it to a file
        env:
          HOSTCERT_BASE64: ${{ secrets.HOSTCERT_BASE64 }}
          HOSTKEY_BASE64: ${{ secrets.HOSTKEY_BASE64 }}
        run: |
          cd Pilot
          mkdir -p etc/grid-security
          echo $HOSTCERT_BASE64 | base64 --decode > etc/grid-security/hostcert.pem
          echo $HOSTKEY_BASE64 | base64 --decode > etc/grid-security/hostkey.pem
          chmod 440 etc/grid-security/hostcert.pem
          chmod 400 etc/grid-security/hostkey.pem
      - name: tests
        run: |
          cd Pilot
          cp ../tests/CI/pilot_oldSchema.json pilot.json
          sed -i "s/VAR_JENKINS_SITE/DIRAC.Jenkins.ch/g" pilot.json
          sed -i "s/VAR_JENKINS_CE/jenkins-full.cern.ch/g" pilot.json
          sed -i "s/VAR_JENKINS_QUEUE/jenkins-queue_not_important/g" pilot.json
          sed -i "s/VAR_DIRAC_VERSION/integration/g" pilot.json
          sed -i "s#VAR_CS#https://lbcertifdirac70.cern.ch:9135/Configuration/Server#g" pilot.json
          sed -i "s#VAR_USERDN#/DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=alboyer/CN=819281/CN=Alexandre Franck Boyer#g" pilot.json
          sed -i "s#VAR_USERDN_GRIDPP#${DIRACUSERDN_GRIDPP}#g" pilot.json
          python dirac-pilot.py --modules https://github.com/DIRACGrid/DIRAC.git:::DIRAC:::integration -M 1 -S DIRAC-Certification -N jenkins-full.cern.ch -Q jenkins-queue_not_important -n DIRAC.Jenkins.ch --wnVO=dteam --cert --certLocation=${GITHUB_WORKSPACE}/Pilot/etc/grid-security --debug


  ##################################
  ### # extensions tests
  ##################################

  ##################################
  #### LHCb

  ext-lhcb_integration:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: add cvmfs
        run: |
          wget https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest_all.deb
          sudo dpkg -i cvmfs-release-latest_all.deb
          rm -f cvmfs-release-latest_all.deb
          sudo apt-get update
          sudo apt-get install cvmfs
          sudo cvmfs_config setup
      - name: Retrieve the secret and decode it to a file
        env:
          HOSTCERT_BASE64: ${{ secrets.HOSTCERT_BASE64 }}
          HOSTKEY_BASE64: ${{ secrets.HOSTKEY_BASE64 }}
        run: |
          cd Pilot
          mkdir -p etc/grid-security/vomses
          mkdir -p etc/grid-security/vomsdir
          mkdir -p etc/grid-security/certificates
          echo $HOSTCERT_BASE64 | base64 --decode > etc/grid-security/hostcert.pem
          echo $HOSTKEY_BASE64 | base64 --decode > etc/grid-security/hostkey.pem
          chmod 440 etc/grid-security/hostcert.pem
          chmod 400 etc/grid-security/hostkey.pem
      - name: tests
        run: |
          cd Pilot
          export VO_LHCB_SW_DIR=${GITHUB_WORKSPACE}/Pilot
          echo $VO_LHCB_SW_DIR
          curl https://lhcbdirac.s3.cern.ch/Pilot3/LHCbPilotCommands.py -o LHCbPilotCommands.py
          cp ../tests/CI/pilot_oldSchema.json pilot.json
          sed -i "s/VAR_JENKINS_SITE/DIRAC.Jenkins.ch/g" pilot.json
          sed -i "s/VAR_JENKINS_CE/jenkins-lhcb.cern.ch/g" pilot.json
          sed -i "s/VAR_JENKINS_QUEUE/jenkins-queue_not_important/g" pilot.json
          sed -i "s/VAR_DIRAC_VERSION/master/g" pilot.json
          sed -i "s#VAR_CS#https://lbcertifdirac70.cern.ch:9135/Configuration/Server#g" pilot.json
          sed -i "s#VAR_USERDN#/DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=alboyer/CN=819281/CN=Alexandre Franck Boyer#g" pilot.json
          sed -i "s#VAR_USERDN_GRIDPP#${DIRACUSERDN_GRIDPP}#g" pilot.json
          ls -al
          python dirac-pilot.py --modules https://gitlab.cern.ch/lhcb-dirac/LHCbDIRAC.git:::LHCbDIRAC:::master -M 1 -S DIRAC-Certification -N jenkins-lhcb.cern.ch -Q jenkins-queue_not_important -n DIRAC.Jenkins.ch -e LHCb -l LHCb -E LHCbPilot --cert --certLocation=${GITHUB_WORKSPACE}/Pilot/etc/grid-security --debug
          cat pilot.cfg
    